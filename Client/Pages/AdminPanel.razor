@page "/admin"
@using CipherQuiz.Shared
@using CipherQuiz.Client.Services
@inject RealtimeService Realtime
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject HttpClient Http
@using System.Threading
@using Microsoft.AspNetCore.SignalR.Client
@implements IAsyncDisposable

<div class="container py-4 animate-fade-in-up">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary glow-text fw-bold">@T("AdminPanel") @(isArchiveView ? @T("ArchiveMode") : "")</h2>
        <div>
            @if (isArchiveView)
            {
                <button class="btn btn-outline-warning btn-glow me-2" @onclick="ExitArchiveView">@T("BackToLive")</button>
            }
            <button class="btn btn-outline-secondary btn-glow" @onclick='() => Nav.NavigateTo("/")'>@T("Exit")</button>
        </div>
    </div>

    @if (string.IsNullOrEmpty(roomCode))
    {
        <div class="cyber-card mx-auto p-4" style="max-width:500px">
            <h4 class="mb-3 text-info">@T("NewRoomTitle")</h4>
            
            <ul class="nav nav-tabs mb-3 border-secondary">
                <li class="nav-item">
                    <button class="nav-link @(activeTab == "new" ? "active bg-dark text-info border-info" : "text-muted")" @onclick='() => activeTab = "new"'>@T("CreateRoomTab")</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(activeTab == "archive" ? "active" : "")" @onclick="LoadArchiveList">@T("ArchiveTab")</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(activeTab == "builder" ? "active" : "")" @onclick='() => activeTab = "builder"'>@T("BuilderTab")</button>
                </li>
            </ul>

            @if (activeTab == "new")
            {
                <div class="mb-3">
                    <label class="form-label">@T("RoomName")</label>
                    <input @bind="roomName" class="form-control" />
                </div>
                <div class="mb-3">
                    <label class="form-label">@T("RoomPassword")</label>
                    <input type="password" @bind="creationPassword" class="form-control" placeholder="@T("RoomPassword")" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Dil / Language</label>
                    <select @bind="selectedLanguage" class="form-select bg-dark text-light border-secondary">
                        <option value="tr">Türkçe</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="mb-3 form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="cryptanalysisMode" @bind="isCryptanalysis">
                    <label class="form-check-label text-warning" for="cryptanalysisMode">@T("CryptoMode")</label>
                    <div class="form-text text-light opacity-50 small">
                        @T("CryptoDesc")
                    </div>
                </div>
                <button class="btn btn-primary-clean w-100 btn-glow" @onclick="CreateRoom">@T("Create")</button>
            }
            else if (activeTab == "archive")
            {
                if (!isAdminUnlocked)
                {
                    <div class="text-center p-4">
                        <h5 class="text-info mb-3">Yönetici Erişimi Gerekli</h5>
                        <div class="mb-3" style="max-width: 300px; margin: 0 auto;">
                            <input type="password" class="form-control bg-dark text-light border-secondary text-center" 
                                   @bind="masterPasswordInput" placeholder="Master Password" @onkeyup="@(e => e.Key == "Enter" ? UnlockAdmin() : null)" />
                        </div>
                        <button class="btn btn-outline-info btn-glow" @onclick="UnlockAdmin">Giriş</button>
                    </div>
                }
                else
                {
                    <div style="max-height: 300px; overflow-y: auto;">
                        @if (archivedRooms == null)
                        {
                            <div class="text-center"><span class="spinner-border spinner-border-sm"></span> Yükleniyor...</div>
                        }
                        else if (archivedRooms.Count == 0)
                        {
                            <div class="text-center text-muted">Arşivlenmiş oturum bulunamadı.</div>
                        }
                        else
                        {
                            <ul class="list-group">
                                @foreach (var ar in archivedRooms)
                                {
                                    <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center bg-transparent text-light border-secondary" 
                                        @onclick="() => LoadRemoteArchive(ar.Code)" style="cursor:pointer">
                                        <div>
                                            <div class="fw-bold">@ar.Name</div>
                                            <small class="text-muted">@ar.StartUtc?.ToLocalTime().ToString("g") - @ar.Code</small>
                                        </div>
                                        <span class="badge bg-info rounded-pill">@ar.Participants.Count</span>
                                    </li>
                                }
                            </ul>
                        }
                    </div>
                }
            }
        </div>
    }
    else
    {
        <div class="row">
            <!-- Left Column: Controls -->
            <div class="col-md-4">
                <div class="cyber-card p-3 mb-3">
                    <h5 class="text-info border-bottom border-secondary pb-2">@T("RoomInfo")</h5>
                    <div class="d-flex justify-content-between align-items-center glass-panel p-2 rounded mb-2">
                        <span class="fs-4 fw-bold font-monospace text-warning">@roomCode</span>
                        @if(!isArchiveView) {
                            <button class="btn btn-sm btn-outline-primary" @onclick="CopyCode" disabled="@string.IsNullOrEmpty(roomCode)">@T("Copy")</button>
                        }
                    </div>
                    @if (!string.IsNullOrEmpty(roomCode) && !isArchiveView)
                    {
                        <div class="d-flex justify-content-between align-items-center glass-panel p-2 rounded border border-secondary mb-3" title="@GetInviteLink()">
                            <div class="text-truncate small text-muted" style="max-width:70%">@GetInviteLink()</div>
                            <button class="btn btn-sm btn-outline-secondary" @onclick="CopyLink">@T("Link")</button>
                        </div>
                    }
                    
                    @if (!isStarted && !isFinished)
                    {
                        <hr class="border-secondary" />
                        <h6 class="text-muted">@T("QuizSettings")</h6>
                        <div class="row">
                            @foreach (var topic in availableTopics)
                            {
                                <div class="col-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               checked="@selectedTopics.ContainsKey(topic)" 
                                               @onchange="@(e => ToggleTopic(topic, e.Value))">
                                        <label class="form-check-label small">@topic</label>
                                    </div>
                                    @if (selectedTopics.ContainsKey(topic))
                                    {
                                        <div class="mt-1">
                                            <input type="number" class="form-control form-control-sm d-inline-block" 
                                                   value="@selectedTopics[topic]" 
                                                   @onchange="@(e => UpdateCount(topic, e.Value))" 
                                                   min="1" max="10" style="width:60px" />
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                        <div class="mb-3">
                            <label class="form-label">@T("TimeLimit")</label>
                            <input type="number" class="form-control" @bind="timeLimitMinutes" min="1" max="120" />
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Dil / Language</label>
                            <select @bind="selectedLanguage" class="form-select bg-dark text-light border-secondary">
                                <option value="tr">Türkçe</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <div class="mb-3 form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="cryptanalysisModeSettings" @bind="isCryptanalysis">
                            <label class="form-check-label text-warning" for="cryptanalysisModeSettings">@T("CryptoModeSettings")</label>
                        </div>
                        <div class="mb-3 form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="sameQuestionsSettings" @bind="sameQuestionsForEveryone">
                            <label class="form-check-label text-info" for="sameQuestionsSettings">@T("SameQuestions")</label>
                            <div class="form-text text-muted small">@T("SameQuestionsDesc")</div>
                        </div>

                        @if (customQuestions.Any())
                        {
                            <div class="mb-3 p-3 border border-secondary rounded glass-panel">
                                <label class="form-label fw-bold text-info border-bottom border-secondary w-100 pb-1">@T("CustomQuestions")</label>
                                <div class="row">
                                    @foreach (var q in customQuestions)
                                    {
                                        <div class="col-md-12 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input bg-dark border-secondary" type="checkbox" id="cq_@q.Id" 
                                                       checked="@selectedCustomQuestionIds.Contains(q.Id)"
                                                       @onchange="@(e => ToggleCustomQuestionSelection(q.Id, e))" />
                                                <label class="form-check-label small text-light" for="cq_@q.Id">
                                                    <span class="badge bg-secondary me-1">@q.Topic</span>
                                                    <span class="text-muted fw-bold me-1">[@q.Key]</span>
                                                    @(q.Text.Length > 40 ? q.Text.Substring(0, 40)+"..." : q.Text)
                                                </label>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        <button class="btn btn-success w-100 btn-glow" @onclick="StartQuiz">@T("StartQuiz")</button>
                    }
                    else if (isStarted)
                    {
                        <div class="alert alert-success bg-opacity-25 bg-success text-white border-success">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>@T("QuizContinuing")</span>
                                <span class="fw-bold font-monospace fs-5">@timeLeft.ToString(@"mm\:ss")</span>
                            </div>
                        </div>
                        <button class="btn btn-danger w-100 btn-glow" @onclick="FinishQuiz">@T("EndQuiz")</button>
                    }
                    else
                    {
                        <div class="alert alert-info bg-opacity-25 bg-info text-white border-info">@T("FinishedMsg")</div>

                        <div class="d-grid gap-2">
                            <a href="api/results/@roomCode/xlsx?adminToken=@adminToken&detailed=false" target="_blank" class="btn btn-success btn-glow">@T("DownloadExcel")</a>
                            <a href="api/results/@roomCode/pdf?adminToken=@adminToken&detailed=false" target="_blank" class="btn btn-danger btn-glow">@T("DownloadPDF")</a>
                            <a href="api/results/@roomCode/full-pdf?adminToken=@adminToken" target="_blank" class="btn btn-warning btn-glow text-dark">@T("DownloadFullPDF")</a>
                            <button class="btn btn-outline-primary btn-glow" @onclick="TriggerShowResults">@T("SeeResults")</button>
                        </div>
                    }
                    
                    <hr class="my-3 border-secondary" />
                    @if (!isArchiveView) {
                        <button class="btn btn-outline-danger w-100 btn-glow" @onclick="CloseRoom">@T("CloseRoom")</button>
                    }
                </div>

            </div>

            <!-- Right Column: Scoreboard & Participants -->
            <div class="col-md-8">
                <div class="cyber-card p-3">
                    <h5 class="text-info border-bottom border-secondary pb-2">@T("Scoreboard")</h5>
                    <table class="table table-hover table-dark bg-transparent">
                        <thead>
                            <tr>
                                <th>@T("Rank")</th>
                                <th>@T("Name")</th>
                                <th>@T("Score")</th>
                                <th>@T("Question")</th>
                                <th>@T("Status")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{ int rank = 1; }
                            @foreach (var s in scoreboard)
                            {
                                var rowClass = rank == 1 ? "top-rank-1" : rank == 2 ? "top-rank-2" : rank == 3 ? "top-rank-3" : "";
                                <tr class="@rowClass scoreboard-row">
                                    <td>@(rank++)</td>
                                    <td>@s.DisplayName</td>
                                    <td>@s.Score.ToString("F1")</td>
                                    <td>
                                        @if(s.IsFinished) { <span class="text-success fw-bold">Bitti</span> }
                                        else { <span>@s.CurrentQuestionIndex</span> }
                                    </td>
                                    <td>
                                        @if(s.IsFinished) { <span class="badge bg-success">@T("Finished")</span> }
                                        else { <span class="badge bg-warning text-dark">@T("Solving")</span> }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="card-clean mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5>@T("Participants") (@participants.Count)</h5>
                        @if (participants.Any(p => !p.IsApproved) && !isArchiveView)
                        {
                            <button class="btn btn-sm btn-success" @onclick="ApproveAll">@T("ApproveAll")</button>
                        }
                    </div>
                    <ul class="list-group list-group-flush">
                        @foreach (var p in participants)
                        {
                            <li class="list-group-item d-flex align-items-center participant-item">
                                <span class="me-2">
                                    @p.DisplayName
                                    <button class="btn btn-sm @(participantAlerts.ContainsKey(p.ParticipantId) && participantAlerts[p.ParticipantId] ? "btn-link text-danger animate-blink" : "btn-link text-warning") p-0 ms-2" @onclick="() => ShowLogs(p.ParticipantId)" title="Logları Gör">
                                        <span class="oi oi-warning" aria-hidden="true">!</span>
                                    </button>
                                    <button class="btn btn-sm btn-link text-info p-0 ms-2" @onclick="() => ShowDetails(p.ParticipantId)" title="Detayları Gör">
                                        <span class="oi oi-list" aria-hidden="true">&#9776;</span>
                                    </button>

                                </span>
                                
                                <div class="d-flex align-items-center gap-2 ms-auto">
                                    @if (!p.IsApproved && !isArchiveView)
                                    {
                                        <span class="badge bg-secondary me-2">@T("Waiting")</span>
                                        <button class="btn btn-sm btn-success" @onclick="() => Approve(p.ParticipantId)">@T("Approve")</button>
                                        <button class="btn btn-sm btn-danger" @onclick="() => Reject(p.ParticipantId)">@T("Reject")</button>
                                    }
                                    else
                                    {
                                        <span class="badge @(p.IsFinished ? "bg-success" : "bg-info text-dark")">
                                            @if (p.IsFinished) 
                                            { 
                                                @T("Finished")
                                            }
                                            else
                                            {
                                                @T("Approved")
                                            }
                                        </span>
                                    }
                                    @if(!isArchiveView) {
                                        <button class="btn btn-sm btn-outline-danger py-0 px-2 ms-3" @onclick="() => Kick(p.ParticipantId)" title="At">×</button>
                                    }
                                </div>
                            </li>
                        }
                    </ul>
                </div>

                @if (ShowPodium && scoreboard.Any())
                {
                    <div class="modal-backdrop-custom">
                        <div class="modal-content-custom modal-content-fullscreen">
                            <button class="btn-close-custom" @onclick="() => ShowPodium = false">×</button>
                            <div class="text-center w-100 h-100 d-flex flex-column justify-content-center">
                                <h2 class="mb-4 text-primary">@T("Results")</h2>
                                <div class="podium-container podium-confetti flex-grow-1" style="max-height: 500px;">
                                    @if (scoreboard.Count >= 2)
                                    {
                                        <div class="podium-bar podium-2" style="height: 0; animation: growBar 1s ease-out forwards 0.5s;">
                                            <div>@scoreboard[1].DisplayName</div>
                                            <div class="fw-bold">@scoreboard[1].Score.ToString("F0")</div>
                                        </div>
                                    }
                                    @if (scoreboard.Count >= 1)
                                    {
                                        <div class="podium-bar podium-1" style="height: 0; animation: growBar 1s ease-out forwards 1.5s;">
                                            <div class="fs-4">1</div>
                                            <div>@scoreboard[0].DisplayName</div>
                                            <div class="fw-bold">@scoreboard[0].Score.ToString("F0")</div>
                                        </div>
                                    }
                                    @if (scoreboard.Count >= 3)
                                    {
                                        <div class="podium-bar podium-3" style="height: 0; animation: growBar 1s ease-out forwards 1s;">
                                            <div>@scoreboard[2].DisplayName</div>
                                            <div class="fw-bold">@scoreboard[2].Score.ToString("F0")</div>
                                        </div>
                                    }
                                </div>
                                
                                @if (scoreboard.Count > 3)
                                {
                                    <div class="mt-4 text-start mx-auto" style="max-width: 600px; width: 100%;">
                                        <h4 class="text-center mb-3">@T("OtherParticipants")</h4>
                                        <ul class="list-group" style="max-height: 200px; overflow-y: auto;">
                                            @for (int i = 3; i < scoreboard.Count; i++)
                                            {
                                                var s = scoreboard[i];
                                                <li class="list-group-item d-flex justify-content-between align-items-center" 
                                                    style="opacity: 0; animation: fadeInList 0.5s ease forwards @(2.5 + (i-3)*0.2)s">
                                                    <span>@(i + 1). @s.DisplayName</span>
                                                    <span class="fw-bold">@s.Score.ToString("F0")</span>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }

            </div>
        </div>
    }

    @if (showLogModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.8);">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-animate-pop">
                <div class="modal-content cyber-card border-info text-light">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title text-info">Kullanıcı Logları: @selectedLogUser</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="() => showLogModal = false"></button>
                    </div>
                    <div class="modal-body bg-dark p-3" style="font-family: 'Courier New', monospace; color: #e0f4ff; min-height: 300px;">
                        @if (selectedUserLogs.Count == 0) { <div class="text-muted text-center mt-4">Henüz log kaydı yok.</div> }
                        @foreach(var log in selectedUserLogs)
                        {
                            <div class="border-bottom border-secondary py-2">@log</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    @if (showDetailsModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.8);">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg modal-animate-pop">
                <div class="modal-content border-info text-light" style="background-color: #05101a; border: 1px solid #004080; box-shadow: 0 0 20px rgba(0, 64, 128, 0.5);">
                    <div class="modal-header border-secondary" style="background-color: #081420;">
                        <div>
                            <h5 class="modal-title text-info fw-bold">Detaylı Rapor: @selectedDetailsUser</h5>
                            <span class="badge bg-warning text-dark mt-1">Toplam Puan: @selectedParticipantDetails.Where(x => x.IsSolved).Sum(x => x.RemainingScore).ToString("F0")</span>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => showDetailsModal = false" style="font-weight: bold; width: 30px; height: 30px; padding: 0; line-height: 0;">X</button>
                    </div>
                    <div class="modal-body p-3" style="color: #e0f4ff; background-color: #05101a;">
                        @if (selectedParticipantDetails.Count == 0) { <div class="text-muted text-center mt-4">Veri yok.</div> }
                        @foreach(var q in selectedParticipantDetails.OrderBy(x => x.Position))
                        {
                            <div class="card mb-3 border-secondary" style="background-color: #0b1c2e;">
                                <div class="card-body">
                                    <h6 class="card-title text-warning">Soru @q.Position: @q.Topic</h6>
                                    <p class="card-text">@q.Prompt</p>
                                    
                                    @if(q.Data != null)
                                    {
                                        <div class="bg-dark p-2 rounded mb-3 border border-secondary bg-opacity-50">
                                            @{ var playfairKey = q.Data.TryGetValue("Anahtar Kelime", out var pk) ? pk : ""; }

                                            @if (q.Data.ContainsKey("Matrix_00"))
                                            {
                                                <div class="mb-2 text-light">
                                                    <strong>Anahtar Matrisi:</strong>
                                                    <div class="d-flex justify-content-start mt-2">
                                                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; width: 100px;">
                                                            <div class="playfair-cell">@q.Data["Matrix_00"]</div>
                                                            <div class="playfair-cell">@q.Data["Matrix_01"]</div>
                                                            <div class="playfair-cell">@q.Data["Matrix_10"]</div>
                                                            <div class="playfair-cell">@q.Data["Matrix_11"]</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                            
                                            @if (q.Data.ContainsKey("MixedAlphabet"))
                                            {
                                                 <div class="mb-2 text-light">
                                                    <strong>Alfabe Eşleşmesi:</strong>
                                                    <div class="mt-2">
                                                        <div class="text-muted small mb-1">Düz Alfabe (A-Z)</div>
                                                        <div class="font-monospace text-warning small" style="letter-spacing: 2px; word-break: break-all;">ABCDEFGHIJKLMNOPQRSTUVWXYZ</div>
                                                        <div class="text-muted small mt-2 mb-1">Karışık Alfabe</div>
                                                        <div class="font-monospace text-info small" style="letter-spacing: 2px; word-break: break-all;">@q.Data["MixedAlphabet"]</div>
                                                    </div>
                                                </div>
                                            }

                                            @foreach (var d in q.Data)
                                            {
                                                @if (d.Key.StartsWith("Matrix_") || d.Key == "MixedAlphabet") continue;

                                                @if (d.Key == "Matris" || d.Key == "Matrix")
                                                {
                                                    var rows = d.Value.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries)
                                                                      .Select(r => r.Trim())
                                                                      .Where(r => r.Length > 0)
                                                                      .ToList();
                                                    <div class="mb-2 text-light">
                                                        <strong>@d.Key:</strong>
                                                        <div class="playfair-matrix-wrapper mt-2 justify-content-start">
                                                            <div class="playfair-matrix">
                                                                @for (int r = 0; r < rows.Count; r++)
                                                                {
                                                                    var row = rows[r];
                                                                    for (int c = 0; c < row.Length; c++)
                                                                    {
                                                                        var ch = row[c];
                                                                        var isKeyword = !string.IsNullOrEmpty(playfairKey) && (playfairKey.ToUpperInvariant().Contains(ch) || (ch == 'I' && playfairKey.ToUpperInvariant().Contains('J')));
                                                                        <div class="playfair-cell @(isKeyword ? "playfair-key-cell" : "")">@(ch == 'I' ? "I/J" : ch.ToString())</div>
                                                                    }
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="mb-1 text-light small"><strong>@d.Key:</strong> <span class="font-monospace text-warning">@d.Value</span></div>
                                                }
                                            }
                                        </div>
                                    }

                                    <div class="row mt-2">
                                        <div class="col-md-6">
                                            <div class="p-2 rounded @(q.IsSolved ? "bg-success bg-opacity-25" : "bg-danger bg-opacity-25")">
                                                <strong>Verilen Cevap:</strong> @(string.IsNullOrEmpty(q.UserAnswer) ? "-" : q.UserAnswer)
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="p-2 rounded bg-info bg-opacity-10">
                                                <strong>Doğru Cevap:</strong> @q.CorrectAnswer
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-2 small d-flex gap-3">
                                        <span class="badge bg-secondary">Deneme: @q.Attempts</span>
                                        <span class="badge bg-secondary">Kazanılan Puan: @(q.IsSolved ? q.RemainingScore.ToString("F1") : "0")</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

    }

    @if (activeTab == "builder")
    {
        if (!isAdminUnlocked)
        {
             <div class="cyber-card mb-4 shadow-sm p-5 text-center" style="max-width: 500px; margin: 0 auto;">
                <h4 class="text-info mb-3">Soru Üretici Erişimi</h4>
                <p class="text-muted mb-4">Bu alana sadece yetkili yöneticiler erişebilir.</p>
                <div class="mb-3">
                    <input type="password" class="form-control bg-dark text-light border-secondary text-center" 
                           @bind="masterPasswordInput" placeholder="Master Password" @onkeyup="@(e => e.Key == "Enter" ? UnlockAdmin() : null)" />
                </div>
                <button class="btn btn-primary-clean btn-glow w-100" @onclick="UnlockAdmin">Kilidi Aç</button>
            </div>
        }
        else
        {
            <div class="row">
            <div class="col-md-5">
                <div class="cyber-card mb-4 shadow-sm p-3">
                    <h5 class="text-info border-bottom border-secondary pb-2">Yeni Soru Ekle</h5>
                    <div class="card-body px-0">
                        <div class="mb-3">
                            <label class="form-label text-light">Konu</label>
                            <select class="form-select bg-dark text-light border-secondary" @bind="newCustomQuestion.Topic">
                                @foreach (var t in availableTopics)
                                {
                                    <option value="@t">@t</option>
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-light">Mod</label>
                            <select class="form-select bg-dark text-light border-secondary" @bind="newCustomQuestion.Mode">
                                <option value="Encrypt">Şifrele (Encrypt)</option>
                                <option value="Decrypt">Çöz (Decrypt)</option>
                            </select>
                        </div>
                        <div class="mb-3 form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="cq_is_analysis" @bind="newCustomQuestion.IsAnalysis">
                            <label class="form-check-label text-warning" for="cq_is_analysis">Kripto Analiz Sorusu mu?</label>
                            <div class="form-text text-muted small">
                                Açılırsa: Caesar için şifre çözülmesi istenir (Key gizlenir).
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-light">@GetKeyLabel(newCustomQuestion.Topic)</label>
                            @if (newCustomQuestion.Topic != "Base64")
                            {
                                <input type="text" class="form-control bg-dark text-light border-secondary" @bind="newCustomQuestion.Key" placeholder="@GetKeyPlaceholder(newCustomQuestion.Topic)" />
                            }
                            else
                            {
                                <input type="text" class="form-control bg-dark text-muted border-secondary" value="Gerekmiyor (Not Required)" disabled />
                            }
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-light">@getTextLabel(newCustomQuestion.Topic, newCustomQuestion.Mode)</label>
                            <textarea class="form-control bg-dark text-light border-secondary" rows="3" @bind="newCustomQuestion.Text" placeholder="..."></textarea>
                        </div>
                        <button class="btn btn-success w-100 btn-glow" @onclick="SaveCustomQuestion">Soruyu Kaydet</button>
                    </div>
                </div>
            </div>

            <div class="col-md-7">
                <div class="cyber-card shadow-sm p-3">
                    <h5 class="text-info border-bottom border-secondary pb-2">Kayıtlı Sorular</h5>
                    <div class="card-body px-0 p-0">
                        @if (!customQuestions.Any())
                        {
                            <div class="p-3 text-center text-muted">Henüz kayıtlı soru yok.</div>
                        }
                        else
                        {
                            <ul class="list-group list-group-flush bg-transparent">
                                @foreach (var q in customQuestions.OrderByDescending(x => x.CreatedAt))
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-secondary text-light">
                                        <div>
                                            <span class="badge bg-secondary me-2">@q.Topic</span>
                                            <span class="badge @(q.Mode == "Encrypt" ? "bg-info text-dark" : "bg-warning text-dark") me-2">@q.Mode</span>
                                            @if (q.IsAnalysis)
                                            {
                                                <span class="badge bg-danger text-white me-2">Analiz</span>
                                            }
                                            <small class="text-muted fw-bold me-2">Key: @q.Key</small>
                                            <div class="text-truncate text-light text-opacity-75" style="max-width: 300px; font-size: 0.9em;">@q.Text</div>
                                        </div>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteCustomQuestion(q.Id)">Sil</button>
                                    </li>
                                }
                            </ul>
                        }
                    </div>
                </div>
            </div>
            </div>
        }
    }

</div>
@code {
    // Localization Logic
    private string T(string key)
    {
        if (translations.ContainsKey(selectedLanguage) && translations[selectedLanguage].ContainsKey(key))
            return translations[selectedLanguage][key];
        return translations["tr"].ContainsKey(key) ? translations["tr"][key] : key;
    }

    private Dictionary<string, Dictionary<string, string>> translations = new()
    {
        { "tr", new() {
            { "NewRoom", "Yeni Oda" },
            { "NewRoomTitle", "Yeni Oda Kur" },
            { "CreateRoomTab", "Yeni Oda" },
            { "ArchiveTab", "Geçmiş Oturumlar" },
            { "BuilderTab", "Soru Üretici" },
            { "RoomName", "Oda Adı" },
            { "RoomPassword", "Özel Şifre" },
            { "Create", "Oluştur" },
            { "RoomInfo", "Oda Bilgileri" },
            { "Copy", "Kopyala" },
            { "Link", "Link" },
            { "TimeLimit", "Süre (Dakika)" },
            { "QuizSettings", "Quiz Ayarları" },
            { "CryptoMode", "Kripto Analiz Modu (Zor - Hard)" },
            { "CryptoModeSettings", "Kripto Analiz Modu" },
            { "CryptoDesc", "Aktif edilirse: Sorular anlamlı metinlerden oluşur. Caesar için şifre çözülmeli, diğerleri için Anahtar bulunmalıdır." },
            { "SameQuestions", "Herkese Aynı Sorular" },
            { "SameQuestionsDesc", "Aktifse: Herkese birebir aynı sorular sorulur." },
            { "CustomQuestions", "Özel Sorular" },
            { "StartQuiz", "Quiz'i Başlat" },
            { "EndQuiz", "Quiz'i Sonlandır" },
            { "QuizContinuing", "Quiz Devam Ediyor..." },
            { "FinishedMsg", "Quiz Tamamlandı" },
            { "CloseRoom", "Odayı Kapat" },
            { "Scoreboard", "Canlı Skor Tablosu" },
            { "Participants", "Katılımcılar" },
            { "ApproveAll", "Hepsini Onayla" },
            { "Approve", "Onay" },
            { "Reject", "Red" },
            { "Kick", "At" },
            { "Waiting", "Bekliyor" },
            { "Approved", "Onaylı" },
            { "Finished", "Bitti" },
            { "Rank", "Sıra" },
            { "Name", "İsim" },
            { "Score", "Puan" },
            { "Question", "Soru" },
            { "Status", "Durum" },
            { "Solving", "Çözüyor" },
            { "Exit", "Çıkış" },
            { "BackToLive", "Canlı Moda Dön" },
            { "AdminPanel", "ADMIN PANELİ" },
            { "ArchiveMode", "(ARŞİV MODU)" },
            { "Results", "Sonuçlar" },
            { "DownloadExcel", "Excel İndir" },
            { "DownloadPDF", "PDF İndir (Özet)" },
            { "DownloadFullPDF", "Detaylı PDF (Tümü)" },
            { "SeeResults", "Sonuçları Gör" },
            { "OtherParticipants", "Diğer Katılımcılar" }
        }},
        { "en", new() {
            { "NewRoom", "New Room" },
            { "NewRoomTitle", "Create New Room" },
            { "CreateRoomTab", "New Room" },
            { "ArchiveTab", "Past Sessions" },
            { "BuilderTab", "Question Builder" },
            { "RoomName", "Room Name" },
            { "RoomPassword", "Room Password" },
            { "Create", "Create" },
            { "RoomInfo", "Room Info" },
            { "Copy", "Copy" },
            { "Link", "Link" },
            { "TimeLimit", "Time Limit (Minutes)" },
            { "QuizSettings", "Quiz Settings" },
            { "CryptoMode", "Cryptanalysis Mode (Hard)" },
            { "CryptoModeSettings", "Cryptanalysis Mode" },
            { "CryptoDesc", "If active: Questions use meaningful text. Must decrypt for Caesar, find Key for others." },
            { "SameQuestions", "Same Questions for Everyone" },
            { "SameQuestionsDesc", "If active: Everyone gets the exact same questions." },
            { "CustomQuestions", "Custom Questions" },
            { "StartQuiz", "Start Quiz" },
            { "EndQuiz", "End Quiz" },
            { "QuizContinuing", "Quiz is Running..." },
            { "FinishedMsg", "Quiz Finished" },
            { "CloseRoom", "Close Room" },
            { "Scoreboard", "Live Scoreboard" },
            { "Participants", "Participants" },
            { "ApproveAll", "Approve All" },
            { "Approve", "Approve" },
            { "Reject", "Reject" },
            { "Kick", "Kick" },
            { "Waiting", "Waiting" },
            { "Approved", "Approved" },
            { "Finished", "Finished" },
             { "Rank", "Rank" },
            { "Name", "Name" },
            { "Score", "Score" },
            { "Question", "Question" },
            { "Status", "Status" },
            { "Solving", "Solving" },
            { "Exit", "Exit" },
            { "BackToLive", "Back to Live Mode" },
            { "AdminPanel", "ADMIN PANEL" },
            { "ArchiveMode", "(ARCHIVE MODE)" },
            { "Results", "Results" },
            { "DownloadExcel", "Download Excel" },
            { "DownloadPDF", "Download PDF (Summary)" },
            { "DownloadFullPDF", "Detailed PDF (Full)" },
            { "SeeResults", "See Results" },
            { "OtherParticipants", "Other Participants" }
        }}
    };

    // Custom Question Logic Added
    private string roomName = "Cipher Room";
    private string creationPassword = "";
    private string adminName = "Yönetici"; // Default or derived from server
    private string roomCode = "";
    private string adminToken = "";

    // Security Logic
    private bool isAdminUnlocked = false;
    private string masterPasswordInput = "";

    private async Task UnlockAdmin()
    {
        if (await Realtime.ValidateMasterPassword(masterPasswordInput))
        {
            isAdminUnlocked = true;
            masterPasswordInput = ""; // Clear
             if (activeTab == "archive") await LoadArchiveList(); // Reload if needed
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Hatalı Şifre!");
        }
    }



    private bool isStarted = false;
    private bool isFinished = false;
    private int timeLimitMinutes = 20;

    private List<string> availableTopics = new() { "Caesar", "Vigenere", "Base64", "Xor", "Hill", "Monoalphabetic", "Playfair", "Transposition" };
    private Dictionary<string, int> selectedTopics = new() { { "Caesar", 1 }, { "Vigenere", 1 } };

    private List<ParticipantDto> participants = new();
    private List<ScoreboardEntryDto> scoreboard = new();
    private Dictionary<string, List<string>> userLogsMap = new();
    private bool showLogModal = false;
    private string selectedLogUser = "";
    private List<string> selectedUserLogs = new();

    private bool showDetailsModal = false;
    private string selectedDetailsUser = "";
    private List<QuestionState> selectedParticipantDetails = new();
    


    private string selectedLanguage = "tr";
    private string activeTab = "new";
    private bool isCryptanalysis = false;
    private bool sameQuestionsForEveryone = false;

    // Missing Fields Restored
    private List<CustomQuestion> customQuestions = new();
    private List<string> selectedCustomQuestionIds = new();
    private CustomQuestion newCustomQuestion = new();
    private Room? currentArchiveRoom;

    // ...

    private async Task CreateRoom()
    {
        try 
        {
            var result = await Realtime.CreateRoom(roomName, creationPassword, selectedLanguage, selectedCustomQuestionIds, isCryptanalysis);
            roomCode = result.RoomCode;
            adminToken = result.AdminToken;
            
            // Sync local variables just in case (already set by UI but good practice)
            // No need to fetch, we are the source of truth here.
            // await PersistSession();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", "Hata: " + ex.Message);
        }
    }

    private string GetKeyLabel(string topic)
    {
        return topic switch
        {
            "Caesar" => "Öteleme Miktarı (Shift - Sayı)",
            "Hill" => "Matris Değerleri (a,b,c,d)",
            "Xor" => "Değer 2 (0-255)",
            "Base64" => "Anahtar (Yok)",
            _ => "Anahtar Kelime (Keyword)"
        };
    }

    private string GetKeyPlaceholder(string topic)
    {
        return topic switch
        {
            "Caesar" => "Örn: 3",
            "Hill" => "Örn: 3,5,6,17",
            "Xor" => "Örn: 123",
            _ => "Örn: KEYWORD"
        };
    }

    private string getTextLabel(string topic, string mode)
    {
        if (topic == "Xor") return "Değer 1 (0-255)";
        
        var type = mode == "Encrypt" ? "Düz Metin (Plaintext)" : "Şifreli Metin (Ciphertext)";
        return $"İşlenecek Metin ({type})";
    }

    private async Task LoadCustomQuestions()
    {
        customQuestions = await Http.GetFromJsonAsync<List<CustomQuestion>>("api/custom-questions") ?? new();
        StateHasChanged();
    }

    private async Task SaveCustomQuestion()
    {
        if (string.IsNullOrWhiteSpace(newCustomQuestion.Text)) return;
        await Http.PostAsJsonAsync("api/custom-questions", newCustomQuestion);
        newCustomQuestion = new CustomQuestion(); // Reset
        await LoadCustomQuestions();
    }

    private async Task DeleteCustomQuestion(string id)
    {
        await Http.DeleteAsync($"api/custom-questions/{id}");
        await LoadCustomQuestions();
    }

    private void ToggleCustomQuestionSelection(string id, ChangeEventArgs e)
    {
        bool isChecked = (bool)(e.Value ?? false);
        if (isChecked)
        {
            if (!selectedCustomQuestionIds.Contains(id)) selectedCustomQuestionIds.Add(id);
        }
        else
        {
            selectedCustomQuestionIds.Remove(id);
        }
    }

    // ... existing archivedRooms and logic 
    private List<Room>? archivedRooms;
    // ...
    private bool isArchiveView = false;
    private System.Threading.Timer? _timer;
    private bool ShowPodium = false;
    private TimeSpan timeLeft;
    private DateTime? quizStartTime;

    private Dictionary<string, bool> participantAlerts = new();

    protected override async Task OnInitializedAsync()
    {
        await Realtime.StartConnection();
        Realtime.OnParticipantListChanged += (list) => InvokeAsync(() => { participants = list; StateHasChanged(); });
        Realtime.OnScoreboardUpdated += (list) => InvokeAsync(() => { scoreboard = list; StateHasChanged(); });
        Realtime.OnQuizStarted += (t, c) => InvokeAsync(() => { 
            isStarted = true; 
            isFinished = false; 
            ShowPodium = false; 
            quizStartTime = t;
            timeLimitMinutes = c.TimeLimitMinutes;
            StateHasChanged(); 
        });
        Realtime.OnQuizFinished += () => InvokeAsync(() => { isStarted = false; isFinished = true; ShowPodium = true; StateHasChanged(); });
        Realtime.OnProctorEventReceived += (pid, ev) => InvokeAsync(() =>
        {
            if (!userLogsMap.ContainsKey(pid)) userLogsMap[pid] = new List<string>();
            var content = string.IsNullOrEmpty(ev.Content) ? "" : $": {ev.Content}";
            userLogsMap[pid].Insert(0, $"[{ev.TimestampUtc.ToLocalTime().ToString("HH:mm:ss")}] {ev.Type}{content}");
            
            // Set alert if modal not open for this user
            if (!showLogModal || selectedLogUser != (participants.FirstOrDefault(x => x.ParticipantId == pid)?.DisplayName ?? pid))
            {
                participantAlerts[pid] = true;
            }

            if (showLogModal && selectedLogUser == (participants.FirstOrDefault(x => x.ParticipantId == pid)?.DisplayName ?? pid))
            {
                selectedUserLogs = userLogsMap[pid];
            }
            StateHasChanged();
        });
        Realtime.OnShowResults += () => InvokeAsync(() => { ShowPodium = true; StateHasChanged(); });

        await RestoreSession();
        await LoadCustomQuestions();

        // Start timer to check time every 1 second for UI update, but server check every 5
        _timer = new System.Threading.Timer(async _ => await CheckTime(), null, 1000, 1000);
    } 

    private async Task CheckTime()
    {
        if (isStarted && !string.IsNullOrEmpty(roomCode) && !isArchiveView)
        {
             // Update UI timer locally
             if (quizStartTime.HasValue)
             {
                 var elapsed = DateTime.UtcNow - quizStartTime.Value;
                 var limit = TimeSpan.FromMinutes(timeLimitMinutes);
                 var remaining = limit - elapsed;
                 if (remaining < TimeSpan.Zero) remaining = TimeSpan.Zero;
                 
                 // Only update UI if second changed substantially to avoid flicker? 
                 // Actually Blazor diffing handles it well.
                 if ((int)remaining.TotalSeconds != (int)timeLeft.TotalSeconds)
                 {
                     timeLeft = remaining;
                     await InvokeAsync(StateHasChanged);
                 }
                 
                 // Periodically notify server? Realtime.CheckTime logic is already server side but triggered by client?
                 // Wait, original logic called Realtime.CheckTime every 5 seconds.
                 // Now we are calling this method every 1 second.
                 // We should only call Server CheckTime periodically, e.g. every 5th tick or simply check elapsed.
                 if (((int)elapsed.TotalSeconds) % 5 == 0)
                 {
                     await Realtime.CheckTime(roomCode);
                 }
             }
        }
    }

    private async Task LoadArchiveList()
    {
        activeTab = "archive";
        archivedRooms = await Http.GetFromJsonAsync<List<Room>>("api/archive");
    }

    private async Task LoadRemoteArchive(string code)
    {
        try
        {
            var room = await Http.GetFromJsonAsync<Room>($"api/archive/{code}");
            if (room != null)
            {
                 currentArchiveRoom = room;
                 isArchiveView = true;
                 roomCode = room.Code;
                 roomName = room.Name;
                 adminName = "Arşiv"; // or room.AdminName if exists? but room has none
                 isStarted = false;
                 isFinished = true; // archives are finished
                 
                 participants = room.Participants.Select(p => new ParticipantDto 
                 { 
                     ParticipantId = p.ParticipantId, 
                     DisplayName = p.DisplayName, 
                     IsApproved = p.IsApproved, 
                     IsFinished = p.IsFinished 
                 }).ToList();

                 scoreboard = room.Quiz.Values.Select(qs => new ScoreboardEntryDto
                 {
                    DisplayName = qs.DisplayName,
                    Score = qs.Score,
                    IsFinished = qs.CurrentIndex >= qs.Questions.Count || qs.Questions.All(q=>q.IsSolved || q.Attempts>=2), // approximation
                    CurrentQuestionIndex = qs.CurrentIndex + 1
                 }).OrderByDescending(x => x.Score).ToList();
                 
                 // Logs
                 userLogsMap.Clear();
                 foreach(var kvp in room.ProctorLogs)
                 {
                     userLogsMap[kvp.Key] = kvp.Value.Select(ev => 
                         $"[{ev.TimestampUtc.ToLocalTime().ToString("HH:mm:ss")}] {ev.Type}: {ev.Content}").OrderByDescending(s => s).ToList();
                 }

                 // Details map
                 // We can't use Realtime.GetParticipantDetails directly because it requires room code to be in memory.
                 // But GetDetails fetches from server anyway. Wait, accessing archived room details?
                 // Realtime service calls Hub method 'GetParticipantDetails'.
                 // If the room is Archived, it is removed from 'RoomStore' memory.
                 // So 'GetParticipantDetails' on Hub will fail?
                 // YES! 'GetParticipantDetails' calls '_roomStore.GetRoomAsync(roomCode)'. RoomStore (InMemory) won't have it.
                 // I need to update 'GetParticipantDetails' in Hub to also check archives?
                 // OR I should use the `room` object I just fetched here?
                 // But `ShowDetails` uses `Realtime.GetParticipantDetails`.
                 // I should override `ShowDetails` logic if `isArchiveView` is true.
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading archive: {ex.Message}");
        }
    }

    private void ExitArchiveView()
    {
        isArchiveView = false;
        roomCode = ""; // Clear to go back to create/lobby
        participants.Clear();
        scoreboard.Clear();
        userLogsMap.Clear();
        // Try restore active session
        _ = RestoreSession();
    }



    private void ToggleTopic(string topic, object? value)
    {
        bool isChecked = (bool)(value ?? false);
        if (isChecked)
        {
            if (!selectedTopics.ContainsKey(topic)) selectedTopics[topic] = 1;
        }
        else
        {
            selectedTopics.Remove(topic);
        }
    }

    private void UpdateCount(string topic, object? value)
    {
        if (int.TryParse(value?.ToString(), out int count))
        {
            selectedTopics[topic] = count;
        }
    }

    private void ShowLogs(string pid)
    {
        var p = participants.FirstOrDefault(x => x.ParticipantId == pid);
        selectedLogUser = p?.DisplayName ?? pid;
        
        // Clear alert
        if (participantAlerts.ContainsKey(pid)) participantAlerts[pid] = false;

        if (userLogsMap.ContainsKey(pid))
            selectedUserLogs = userLogsMap[pid];
        else
            selectedUserLogs = new List<string>();
        showLogModal = true;
    }

    private async Task ShowDetails(string pid)
    {
        var p = participants.FirstOrDefault(x => x.ParticipantId == pid);
        selectedDetailsUser = p?.DisplayName ?? pid;
        
        if (isArchiveView)
        {
             // We need to find the room in archivedRooms list? No, we have loaded `room` state but not exposed it to class scope.
             // We need to store the raw loaded room object for archive details.
             // Let's call API again or store it. Storing it is better.
             // QUICK FIX: Since I can't easily add a class field holding `Room` without breaking other things or making it messy
             // I will fetch from API again or just store in a temporary variable.
             // Actually I'll simple add `private Room? currentArchiveRoom;` to class fields.
             if (currentArchiveRoom != null && currentArchiveRoom.Quiz.ContainsKey(pid))
             {
                 selectedParticipantDetails = currentArchiveRoom.Quiz[pid].Questions;
             }
             else 
             {
                 selectedParticipantDetails = new List<QuestionState>();
             }
        }
        else 
        {
             selectedParticipantDetails = await Realtime.GetParticipantDetails(roomCode, adminToken, pid);
        }
        showDetailsModal = true;
    }

    private async Task UpdateConfig()
    {
        var config = new QuizConfig
        {
            Topics = selectedTopics.Keys.ToList(),
            QuestionsPerTopicMap = selectedTopics,
            MistakesPerQuestion = 2,
            TimeLimitMinutes = timeLimitMinutes,
            CustomQuestionIds = selectedCustomQuestionIds, // Fix: Include selected custom questions
            Language = selectedLanguage,    // FIX: Preserve selected language
            IsCryptanalysis = isCryptanalysis, // FIX: Preserve cryptanalysis mode
            SameQuestionsForEveryone = sameQuestionsForEveryone // NEW: Sync Same Questions flag
        };
        await Realtime.UpdateConfig(roomCode, adminToken, config);
    }

    private async Task StartQuiz() 
    {
        await UpdateConfig(); // Ensure latest config is sent
        await Realtime.StartQuiz(roomCode, adminToken);
    }
    
    private async Task FinishQuiz() => await Realtime.FinishQuiz(roomCode, adminToken);
    private async Task Approve(string pid) => await Realtime.Approve(roomCode, adminToken, pid);
    private async Task Reject(string pid) => await Realtime.Reject(roomCode, adminToken, pid);
    private async Task ApproveAll() => await Realtime.ApproveAll(roomCode, adminToken);
    private async Task Kick(string pid) 
    {
        if (await JS.InvokeAsync<bool>("confirm", "Bu kullanıcıyı atmak istediğinize emin misiniz?"))
        {
            await Realtime.KickParticipant(roomCode, adminToken, pid);
        }
    }
    private string GetInviteLink() => Nav.ToAbsoluteUri($"/room/{roomCode}").ToString();
    private async Task CopyCode() => await JS.InvokeVoidAsync("copyToClipboard", roomCode);
    private async Task CopyLink() => await JS.InvokeVoidAsync("copyToClipboard", GetInviteLink());

    private async Task TriggerShowResults() => await Realtime.ShowResults(roomCode, adminToken);

    private async Task CloseRoom()
    {
        if (!await JS.InvokeAsync<bool>("confirm", "Odayı kapatmak istediğinize emin misiniz? Tüm veriler silinecek.")) return;
        
        try
        {
            await Realtime.CloseRoom(roomCode, adminToken);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error closing room: {ex.Message}");
        }
        finally
        {
            // Clear local storage and reset state regardless of server success
            await JS.InvokeVoidAsync("localStorage.removeItem", "cq_roomCode");
            await JS.InvokeVoidAsync("localStorage.removeItem", "cq_adminToken");
            
            roomCode = "";
            adminToken = "";
            participants.Clear();
            scoreboard.Clear();
            isStarted = false;
            isFinished = false;
            StateHasChanged();
        }
    }

    private async Task PersistSession()
    {
        await JS.InvokeVoidAsync("localStorage.setItem", "cq_roomCode", roomCode);
        await JS.InvokeVoidAsync("localStorage.setItem", "cq_adminToken", adminToken);
    }

    private async Task RestoreSession()
    {
        var storedCode = await JS.InvokeAsync<string>("localStorage.getItem", "cq_roomCode");
        var storedToken = await JS.InvokeAsync<string>("localStorage.getItem", "cq_adminToken");
        if (!string.IsNullOrWhiteSpace(storedCode) && !string.IsNullOrWhiteSpace(storedToken))
        {
            var state = await Realtime.ResumeAdmin(storedCode, storedToken);
            if (state.HasValue)
            {
                roomCode = storedCode;
                adminToken = storedToken;
                isStarted = state == RoomState.Running;
                isFinished = state == RoomState.Finished;
                
                // If running, we need start time to resume timer!
                // Realtime.ResumeAdmin only returns RoomState enum.
                // We need to fetch full room info or at least start time.
                // Or update ResumeAdmin to return more info. 
                // But ResumeAdmin is simple. 
                // We can use Http to get room info if we want? Or update ResumeAdmin.
                // Actually, let's just use GetRoom via HTTP? Or add method to RealtimeService.
                // Let's use Http to fetch room info for Admin. Validated by AdminToken? 
                // The current API might not expose GetRoom for admin easily without token validation.
                // Let's assume for now we don't show timer on Resume unless we fetch it.
                // Better fix: Add GetRoomInfo to RealtimeService called after Resume.
                // Sync Config from Server
                try 
                {
                     var roomInfo = await Realtime.GetRoomInfo(roomCode, adminToken);
                     if(roomInfo != null)
                     {
                         quizStartTime = roomInfo.StartUtc;
                         timeLimitMinutes = roomInfo.Config.TimeLimitMinutes;
                         
                         // FIX: Sync Critical Configs
                         selectedLanguage = roomInfo.Config.Language;
                         isCryptanalysis = roomInfo.Config.IsCryptanalysis;
                         sameQuestionsForEveryone = roomInfo.Config.SameQuestionsForEveryone;
                         
                         // Sync Topics
                         selectedTopics = roomInfo.Config.QuestionsPerTopicMap ?? new Dictionary<string, int>();
                         selectedCustomQuestionIds = roomInfo.Config.CustomQuestionIds ?? new List<string>();
                         // Sync Custom Questions selection in UI? 
                         StateHasChanged();
                     }
                } 
                catch (Exception ex) 
                {
                    Console.WriteLine("Error syncing config: " + ex.Message);
                }
            }
            else
            {
                // Room no longer exists or token invalid
                await JS.InvokeVoidAsync("localStorage.removeItem", "cq_roomCode");
                await JS.InvokeVoidAsync("localStorage.removeItem", "cq_adminToken");
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_timer != null) _timer.Dispose();
    }

 
}
