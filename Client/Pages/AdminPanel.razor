@page "/admin"
@using CipherQuiz.Shared
@using CipherQuiz.Client.Services
@inject RealtimeService Realtime
@inject NavigationManager Nav
@inject IJSRuntime JS
@implements IAsyncDisposable

<div class="container py-4 animate-fade-in-up">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary glow-text fw-bold">ADMIN PANELİ</h2>
        <button class="btn btn-outline-secondary btn-glow" @onclick='() => Nav.NavigateTo("/")'>Çıkış</button>
    </div>

    @if (string.IsNullOrEmpty(roomCode))
    {
        <div class="cyber-card mx-auto p-4" style="max-width:500px">
            <h4 class="mb-3 text-info">Yeni Oda Kur</h4>
            <div class="mb-3">
                <label class="form-label">Oda Adı</label>
                <input @bind="roomName" class="form-control" />
            </div>
            <div class="mb-3">
                <label class="form-label">Admin Adı</label>
                <input @bind="adminName" class="form-control" />
            </div>
            <button class="btn btn-primary-clean w-100 btn-glow" @onclick="CreateRoom">Oluştur</button>
        </div>
    }
    else
    {
        <div class="row">
            <!-- Left Column: Controls -->
            <div class="col-md-4">
                <div class="cyber-card p-3 mb-3">
                    <h5 class="text-info border-bottom border-secondary pb-2">Oda Bilgileri</h5>
                    <div class="d-flex justify-content-between align-items-center glass-panel p-2 rounded mb-2">
                        <span class="fs-4 fw-bold font-monospace text-warning">@roomCode</span>
                        <button class="btn btn-sm btn-outline-primary" @onclick="CopyCode" disabled="@string.IsNullOrEmpty(roomCode)">Kopyala</button>
                    </div>
                    @if (!string.IsNullOrEmpty(roomCode))
                    {
                        <div class="d-flex justify-content-between align-items-center glass-panel p-2 rounded border border-secondary mb-3" title="@GetInviteLink()">
                            <div class="text-truncate small text-muted" style="max-width:70%">@GetInviteLink()</div>
                            <button class="btn btn-sm btn-outline-secondary" @onclick="CopyLink">Link</button>
                        </div>
                    }
                    
                    @if (!isStarted && !isFinished)
                    {
                        <hr class="border-secondary" />
                        <h6 class="text-muted">Quiz Ayarları</h6>
                        <div class="row">
                            @foreach (var topic in availableTopics)
                            {
                                <div class="col-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               checked="@selectedTopics.ContainsKey(topic)" 
                                               @onchange="@(e => ToggleTopic(topic, e.Value))">
                                        <label class="form-check-label small">@topic</label>
                                    </div>
                                    @if (selectedTopics.ContainsKey(topic))
                                    {
                                        <div class="mt-1">
                                            <input type="number" class="form-control form-control-sm d-inline-block" 
                                                   value="@selectedTopics[topic]" 
                                                   @onchange="@(e => UpdateCount(topic, e.Value))" 
                                                   min="1" max="10" style="width:60px" />
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Süre (Dakika)</label>
                            <input type="number" class="form-control" @bind="timeLimitMinutes" min="1" max="120" />
                        </div>
                        <button class="btn btn-primary-clean w-100 mb-2 btn-glow" @onclick="UpdateConfig">Ayarları Kaydet</button>
                        <button class="btn btn-success w-100 btn-glow" @onclick="StartQuiz">Quiz'i Başlat</button>
                    }
                    else if (isStarted)
                    {
                        <div class="alert alert-success bg-opacity-25 bg-success text-white border-success">Quiz Devam Ediyor...</div>
                        <button class="btn btn-danger w-100 btn-glow" @onclick="FinishQuiz">Quiz'i Sonlandır</button>
                    }
                    else
                    {
                        <div class="alert alert-info bg-opacity-25 bg-info text-white border-info">Quiz Tamamlandı</div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" @bind="detailedExport" id="detailedExportCheck">
                            <label class="form-check-label" for="detailedExportCheck">Detaylı Rapor</label>
                        </div>
                        <div class="d-grid gap-2">
                            <a href="api/results/@roomCode/xlsx?adminToken=@adminToken&detailed=@detailedExport" target="_blank" class="btn btn-success btn-glow">Excel İndir</a>
                            <a href="api/results/@roomCode/pdf?adminToken=@adminToken&detailed=@detailedExport" target="_blank" class="btn btn-danger btn-glow">PDF İndir</a>
                            <button class="btn btn-outline-primary btn-glow" @onclick="TriggerShowResults">Sonuçları Gör</button>
                        </div>
                    }
                    
                    <hr class="my-3 border-secondary" />
                    <button class="btn btn-outline-danger w-100 btn-glow" @onclick="CloseRoom">Odayı Kapat</button>
                </div>

            </div>

            <!-- Right Column: Scoreboard & Participants -->
            <div class="col-md-8">
                <div class="cyber-card p-3">
                    <h5 class="text-info border-bottom border-secondary pb-2">Canlı Skor Tablosu</h5>
                    <table class="table table-hover table-dark bg-transparent">
                        <thead>
                            <tr>
                                <th>Sıra</th>
                                <th>İsim</th>
                                <th>Puan</th>
                                <th>Soru</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{ int rank = 1; }
                            @foreach (var s in scoreboard)
                            {
                                var rowClass = rank == 1 ? "top-rank-1" : rank == 2 ? "top-rank-2" : rank == 3 ? "top-rank-3" : "";
                                <tr class="@rowClass scoreboard-row">
                                    <td>@(rank++)</td>
                                    <td>@s.DisplayName</td>
                                    <td>@s.Score.ToString("F1")</td>
                                    <td>
                                        @if(s.IsFinished) { <span class="text-success fw-bold">Bitti</span> }
                                        else { <span>@s.CurrentQuestionIndex</span> }
                                    </td>
                                    <td>
                                        @if(s.IsFinished) { <span class="badge bg-success">Bitti</span> }
                                        else { <span class="badge bg-warning text-dark">Çözüyor</span> }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="card-clean mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5>Katılımcılar (@participants.Count)</h5>
                        @if (participants.Any(p => !p.IsApproved))
                        {
                            <button class="btn btn-sm btn-success" @onclick="ApproveAll">Hepsini Onayla</button>
                        }
                    </div>
                    <ul class="list-group list-group-flush">
                        @foreach (var p in participants)
                        {
                            <li class="list-group-item d-flex align-items-center participant-item">
                                <span class="me-2">
                                    @p.DisplayName
                                    <button class="btn btn-sm @(participantAlerts.ContainsKey(p.ParticipantId) && participantAlerts[p.ParticipantId] ? "btn-link text-danger animate-blink" : "btn-link text-warning") p-0 ms-2" @onclick="() => ShowLogs(p.ParticipantId)" title="Logları Gör">
                                        <span class="oi oi-warning" aria-hidden="true">!</span>
                                    </button>
                                </span>
                                
                                <div class="d-flex align-items-center gap-2 ms-auto">
                                    @if (!p.IsApproved)
                                    {
                                        <span class="badge bg-secondary me-2">Bekliyor</span>
                                        <button class="btn btn-sm btn-success" @onclick="() => Approve(p.ParticipantId)">Onay</button>
                                        <button class="btn btn-sm btn-danger" @onclick="() => Reject(p.ParticipantId)">Red</button>
                                    }
                                    else
                                    {
                                        <span class="badge @(p.IsFinished ? "bg-success" : "bg-info text-dark")">
                                            @(p.IsFinished ? "Bitti" : "Onaylı")
                                        </span>
                                    }
                                    <button class="btn btn-sm btn-outline-danger py-0 px-2 ms-3" @onclick="() => Kick(p.ParticipantId)" title="At">×</button>
                                </div>
                            </li>
                        }
                    </ul>
                </div>

                @if (ShowPodium && scoreboard.Any())
                {
                    <div class="modal-backdrop-custom">
                        <div class="modal-content-custom modal-content-fullscreen">
                            <button class="btn-close-custom" @onclick="() => ShowPodium = false">×</button>
                            <div class="text-center w-100 h-100 d-flex flex-column justify-content-center">
                                <h2 class="mb-4 text-primary">Sonuçlar</h2>
                                <div class="podium-container podium-confetti flex-grow-1" style="max-height: 500px;">
                                    @if (scoreboard.Count >= 2)
                                    {
                                        <div class="podium-bar podium-2" style="height: 0; animation: growBar 1s ease-out forwards 0.5s;">
                                            <div>@scoreboard[1].DisplayName</div>
                                            <div class="fw-bold">@scoreboard[1].Score.ToString("F0")</div>
                                        </div>
                                    }
                                    @if (scoreboard.Count >= 1)
                                    {
                                        <div class="podium-bar podium-1" style="height: 0; animation: growBar 1s ease-out forwards 1.5s;">
                                            <div class="fs-4">1</div>
                                            <div>@scoreboard[0].DisplayName</div>
                                            <div class="fw-bold">@scoreboard[0].Score.ToString("F0")</div>
                                        </div>
                                    }
                                    @if (scoreboard.Count >= 3)
                                    {
                                        <div class="podium-bar podium-3" style="height: 0; animation: growBar 1s ease-out forwards 1s;">
                                            <div>@scoreboard[2].DisplayName</div>
                                            <div class="fw-bold">@scoreboard[2].Score.ToString("F0")</div>
                                        </div>
                                    }
                                </div>
                                
                                @if (scoreboard.Count > 3)
                                {
                                    <div class="mt-4 text-start mx-auto" style="max-width: 600px; width: 100%;">
                                        <h4 class="text-center mb-3">Diğer Katılımcılar</h4>
                                        <ul class="list-group" style="max-height: 200px; overflow-y: auto;">
                                            @for (int i = 3; i < scoreboard.Count; i++)
                                            {
                                                var s = scoreboard[i];
                                                <li class="list-group-item d-flex justify-content-between align-items-center" 
                                                    style="opacity: 0; animation: fadeInList 0.5s ease forwards @(2.5 + (i-3)*0.2)s">
                                                    <span>@(i + 1). @s.DisplayName</span>
                                                    <span class="fw-bold">@s.Score.ToString("F0")</span>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }

            </div>
        </div>
    }

    @if (showLogModal)
    {
        <div class="modal-backdrop-custom">
            <div class="modal-content-custom" style="max-width: 600px; background: #13283f; border: 1px solid #00bfff;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-info">Kullanıcı Logları: @selectedLogUser</h5>
                    <button class="btn-close-custom" @onclick="() => showLogModal = false">×</button>
                </div>
                <div class="bg-dark p-3 rounded border border-secondary" style="height: 400px; overflow-y:auto; font-family: 'Courier New', monospace; color: #e0f4ff;">
                    @if (selectedUserLogs.Count == 0) { <div class="text-muted text-center mt-4">Henüz log kaydı yok.</div> }
                    @foreach(var log in selectedUserLogs)
                    {
                        <div class="border-bottom border-secondary py-2">@log</div>
                    }
                </div>
            </div>
        </div>
    }

</div>

@code {
    private string roomName = "Cipher Room";
    private string adminName = "Admin";
    private string roomCode = "";
    private string adminToken = "";
    private bool detailedExport = false;

    private bool isStarted = false;
    private bool isFinished = false;
    private int timeLimitMinutes = 20;

    private List<string> availableTopics = new() { "Caesar", "Vigenere", "Base64", "Xor", "Hill", "Monoalphabetic", "Playfair", "Transposition" };
    private Dictionary<string, int> selectedTopics = new() { { "Caesar", 2 }, { "Vigenere", 2 } };

    private List<ParticipantDto> participants = new();
    private List<ScoreboardEntryDto> scoreboard = new();
    private Dictionary<string, List<string>> userLogsMap = new();
    private bool showLogModal = false;
    private string selectedLogUser = "";
    private List<string> selectedUserLogs = new();
    private bool ShowPodium = false;

    private Dictionary<string, bool> participantAlerts = new();

    protected override async Task OnInitializedAsync()
    {
        await Realtime.StartConnection();
        Realtime.OnParticipantListChanged += (list) => InvokeAsync(() => { participants = list; StateHasChanged(); });
        Realtime.OnScoreboardUpdated += (list) => InvokeAsync(() => { scoreboard = list; StateHasChanged(); });
        Realtime.OnQuizStarted += (t, c) => InvokeAsync(() => { isStarted = true; isFinished = false; ShowPodium = false; StateHasChanged(); });
        Realtime.OnQuizFinished += () => InvokeAsync(() => { isStarted = false; isFinished = true; ShowPodium = true; StateHasChanged(); });
        Realtime.OnProctorEventReceived += (pid, ev) => InvokeAsync(() =>
        {
            if (!userLogsMap.ContainsKey(pid)) userLogsMap[pid] = new List<string>();
            userLogsMap[pid].Insert(0, $"[{ev.TimestampUtc.ToShortTimeString()}] {ev.Type}");
            
            // Set alert if modal not open for this user
            if (!showLogModal || selectedLogUser != (participants.FirstOrDefault(x => x.ParticipantId == pid)?.DisplayName ?? pid))
            {
                participantAlerts[pid] = true;
            }

            if (showLogModal && selectedLogUser == (participants.FirstOrDefault(x => x.ParticipantId == pid)?.DisplayName ?? pid))
            {
                selectedUserLogs = userLogsMap[pid];
            }
            StateHasChanged();
        });
        Realtime.OnShowResults += () => InvokeAsync(() => { ShowPodium = true; StateHasChanged(); });

        await RestoreSession();
    }

    private async Task CreateRoom()
    {
        var result = await Realtime.CreateRoom(roomName, adminName);
        roomCode = result.RoomCode;
        adminToken = result.AdminToken;
        await PersistSession();
    }

    private void ToggleTopic(string topic, object? value)
    {
        bool isChecked = (bool)(value ?? false);
        if (isChecked)
        {
            if (!selectedTopics.ContainsKey(topic)) selectedTopics[topic] = 2;
        }
        else
        {
            selectedTopics.Remove(topic);
        }
    }

    private void UpdateCount(string topic, object? value)
    {
        if (int.TryParse(value?.ToString(), out int count))
        {
            selectedTopics[topic] = count;
        }
    }

    private void ShowLogs(string pid)
    {
        var p = participants.FirstOrDefault(x => x.ParticipantId == pid);
        selectedLogUser = p?.DisplayName ?? pid;
        
        // Clear alert
        if (participantAlerts.ContainsKey(pid)) participantAlerts[pid] = false;

        if (userLogsMap.ContainsKey(pid))
            selectedUserLogs = userLogsMap[pid];
        else
            selectedUserLogs = new List<string>();
        showLogModal = true;
    }

    private async Task UpdateConfig()
    {
        var config = new QuizConfig
        {
            Topics = selectedTopics.Keys.ToList(),
            QuestionsPerTopicMap = selectedTopics,
            MistakesPerQuestion = 2,
            TimeLimitMinutes = timeLimitMinutes
        };
        await Realtime.UpdateConfig(roomCode, adminToken, config);
    }

    private async Task StartQuiz() 
    {
        await UpdateConfig(); // Ensure latest config is sent
        await Realtime.StartQuiz(roomCode, adminToken);
    }
    
    private async Task FinishQuiz() => await Realtime.FinishQuiz(roomCode, adminToken);
    private async Task Approve(string pid) => await Realtime.Approve(roomCode, adminToken, pid);
    private async Task Reject(string pid) => await Realtime.Reject(roomCode, adminToken, pid);
    private async Task ApproveAll() => await Realtime.ApproveAll(roomCode, adminToken);
    private async Task Kick(string pid) 
    {
        if (await JS.InvokeAsync<bool>("confirm", "Bu kullanıcıyı atmak istediğinize emin misiniz?"))
        {
            await Realtime.KickParticipant(roomCode, adminToken, pid);
        }
    }
    private string GetInviteLink() => Nav.ToAbsoluteUri($"/room/{roomCode}").ToString();
    private async Task CopyCode() => await JS.InvokeVoidAsync("navigator.clipboard.writeText", roomCode);
    private async Task CopyLink() => await JS.InvokeVoidAsync("navigator.clipboard.writeText", GetInviteLink());

    private async Task TriggerShowResults() => await Realtime.ShowResults(roomCode, adminToken);

    private async Task CloseRoom()
    {
        if (!await JS.InvokeAsync<bool>("confirm", "Odayı kapatmak istediğinize emin misiniz? Tüm veriler silinecek.")) return;
        
        try
        {
            await Realtime.CloseRoom(roomCode, adminToken);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error closing room: {ex.Message}");
        }
        finally
        {
            // Clear local storage and reset state regardless of server success
            await JS.InvokeVoidAsync("localStorage.removeItem", "cq_roomCode");
            await JS.InvokeVoidAsync("localStorage.removeItem", "cq_adminToken");
            
            roomCode = "";
            adminToken = "";
            participants.Clear();
            scoreboard.Clear();
            isStarted = false;
            isFinished = false;
            StateHasChanged();
        }
    }

    private async Task PersistSession()
    {
        await JS.InvokeVoidAsync("localStorage.setItem", "cq_roomCode", roomCode);
        await JS.InvokeVoidAsync("localStorage.setItem", "cq_adminToken", adminToken);
    }

    private async Task RestoreSession()
    {
        var storedCode = await JS.InvokeAsync<string>("localStorage.getItem", "cq_roomCode");
        var storedToken = await JS.InvokeAsync<string>("localStorage.getItem", "cq_adminToken");
        if (!string.IsNullOrWhiteSpace(storedCode) && !string.IsNullOrWhiteSpace(storedToken))
        {
            var state = await Realtime.ResumeAdmin(storedCode, storedToken);
            if (state.HasValue)
            {
                roomCode = storedCode;
                adminToken = storedToken;
                isStarted = state == RoomState.Running;
                isFinished = state == RoomState.Finished;
            }
            else
            {
                // Room no longer exists or token invalid
                await JS.InvokeVoidAsync("localStorage.removeItem", "cq_roomCode");
                await JS.InvokeVoidAsync("localStorage.removeItem", "cq_adminToken");
            }
        }
    }

    public ValueTask DisposeAsync() => ValueTask.CompletedTask;
}
